<?php
/**
 * @file
 * stanford_subsites.module
 *
 * @author (s)
 *         Shea McKinney / sherakama
 *
 * @description
 * This module provides helper functionality to the Stanford Subsites
 * feature.
 *
 *
 * @todo :::::::::::::::::::::::::::::::::::::::::::::::::::::::::
 *  remove all 'Features' and have this whole thing as one module using
 *  field api.
 *
 * :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
 */

// The content type that defines a subsite.
define('SUBSITE_CONTENT_TYPE', "stanford_subsite");
// The field that changes the site title.
define("SUBSITE_NAME_FIELD", "field_stanford_subsite_sname");
// The field that changes the site slogan.
define("SUBSITE_SLOGAN_FIELD", "field_stanford_subsite_slogan");
// The field that changes the site logo.
define("SUBSITE_LOGO_FIELD", "field_stanford_subsite_logo");
// The field that changes $front_page.
define("SUBSITE_FRONT_PAGE_FIELD", "field_stanford_subsite_front");
// The field that changes the theme.
define("SUBSITE_THEME_FIELD", "field_stanford_subsite_theme");
// The subsite vocabulary machine name.
define("SUBSITE_VOCAB", "stanford_subsites_sites");
// The subsite tags field.
define("SUBSITE_TAGS_FIELD", "field_stanford_subsite_sub_tags");

// Global variable for active subsite.
global $subsite;

// Load helper files.
module_load_include('inc', 'stanford_subsites', 'stanford_subsites');


/**
 * Implements hook_help().
 *
 * @param string $path
 *    path to help page
 * @param array $arg
 *    args
 * @return array
 */
function stanford_subsites_help($path, $arg) {
  switch ($path) {
    case 'admin/help#stanford_subsites':
      $output = '<h2>' . t('To Use') . '</h2>';
      $output .= '<ol><li>' . t('Enable the module and all dependencies, plus all submodules') . '</li>';
      $output .= '<li>' . t('!permissions and give selected roles the following permissions:', array('!permissions' => l(t('Go to the permissions page'), 'admin/people/permissions#module-stanford_subsites')));
      $output .= '<ul><li>' . t('Administer Subsite') . '</li>';
      $output .= '<li>' . t('Administer Subsite Selection') . '</li></ul></li>';
      $output .= '<li>' . t('!configpage and:', array('!configpage' => l(t('Go to the configuration page'), 'admin/config/subsites')));
      $output .= '<ul><li>' . t('Select content types that can be used within subsites') . '</li>';
      $output .= '<li>' . t('Enable the placement of menu blocks') . '</li>';
      $output .= '<li>' . t('Select theme regions where the main menu blocks should be placed') . '</li></ul></li>';
      $output .= '<li>' . t('!createsubsite and choose theme options', array('!createsubsite' => l(t('Create a new subsite'), 'node/add/stanford-subsite'))) . '</li>';
      $output .= '<li>' . t('!createcontent and select a parent subsite', array('!createcontent' => l(t('Create content'), 'node/add'))) . '</li>';
      $output .= '</ol>';

      $output .= '<h2>' . t('Known Issues') . '</h2>';
      $output .= '<p>' . t('If a user creates a new subsite, the main menu for that subsite becomes available for use in all content types that are available for use in a subsite. If a user then creates a new content type, and enables it for use in subsites, it does not "automagically" have access to any main menus for subsites. The workflow that this implies is that an administrator should create all subsites first, then new content types. Subsequently, if a new content type is created (or added by enabling a Features-based module that defines it), the admin will need to go into the menu settings for the content type and enable the subsite menus that should be available for that content type.') . '</p>';
      return $output;
  }
  return;
}

/**
 * Implements hook_menu().
 */
function stanford_subsites_menu() {
  $items = array();

  $items['admin/config/subsites'] = array(
    'title' => 'Subsite Settings',
    'description' => 'Settings and configuration options for subsite behavior',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('stanford_subsites_admin_config_form'),
    'file' => 'stanford_subsites.admin.inc',
    'access arguments' => array('administer sws'),
  );

  return $items;
}

/**
 * Implements hook_permission().
 */
function stanford_subsites_permission() {
  return array(
    'administer sws' => array(
      'title' => t('Administer Subsite'),
      'description' => t('Perform administration tasks for subsites.'),
    ),
    'administer subsite selection' => array(
      'title' => t('Administer Subsite Selection'),
      'description' => t('Access and change the subsite selection field'),
    ),
  );
}

/**
 * Implements hook_custom_theme().
 */
function stanford_subsites_custom_theme() {

  // Check to see if this page is a node. If so apply subtheme by node reference.
  $subsite_node = stanford_subsites_get_active_subsite();

  // Apply the field values.
  if ($subsite_node &&
    isset($subsite_node->{SUBSITE_THEME_FIELD}[$subsite_node->language][0]['value'])
    && $subsite_node->{SUBSITE_THEME_FIELD}[$subsite_node->language][0]['value'] !== "default") {
    return $subsite_node->{SUBSITE_THEME_FIELD}[$subsite_node->language][0]['value'];
  }

}


/**
 * Add some additional variables to the preprocess page function.
 *
 * For use in the theme templates like $vars['site_name'];
 *
 * @param array $vars
 *   An array or variables
 * @param string $hook
 *   A string of the hook name
 */
function stanford_subsites_preprocess_html(&$vars, $hook) {

  $vars['site_name'] = variable_get('site_name');
  $vars['subsite_site_name_text'] = FALSE;
  $vars['subsite_site_name_html'] = FALSE;

  // Check to see if this page is a node. If so apply subtheme by node reference.
  $subsite_node = stanford_subsites_get_active_subsite();

  if ($subsite_node) {
    $vars['subsite_site_name_text'] = $subsite_node->{SUBSITE_NAME_FIELD}[$subsite_node->language][0]["safe_value"];
    $vars['subsite_site_name_html'] = l($vars['subsite_site_name_text'], "<front>");
  }
  else {
    $vars['subsite_site_name_html'] = l($vars['site_name'], "<front>");
  }

}



/**
 * Implements hook_preprocess()
 */
function stanford_subsites_preprocess_page(&$vars, $hook) {

  // Some variables need to be persistent.
  $vars['subsite_logo_html'] = FALSE; // the subsite logo full html and link
  $vars['subsite_site_name_html'] = FALSE; // the subsite name full html and link
  $vars['subsite_site_name_text'] = FALSE; // the subsite name plain text
  $vars['subsite_name_logo_setting'] = "default";
  $vars['alt'] = $vars['site_name']; // the alt text for the logo image
  $vars['logo_title'] = $vars['site_name']; // The title text for the logo image
  $vars['subsite_is_front'] = FALSE; // boolean value if current type is subsite
  $vars['subsite_front'] = FALSE; // string of the path to the active subsite

  // Check to see if this page is a subsite node type. If it is then we are at
  // a subsite 'front'.
  if (isset($vars['node']) && $vars['node']->type == SUBSITE_CONTENT_TYPE) {
    $vars['subsite_is_front'] = TRUE;
  }

  // Apply the subsite.
  $subsite_node = stanford_subsites_get_active_subsite();

  if ($subsite_node) {
    stanford_subsites_apply_subsite($subsite_node, $vars);
  }
  else {
    if ($vars['logo']) {
      $img = theme("image",
        array(
          'path' => $vars['logo'],
          'role' => 'presentation',
          'alt' => check_plain($vars['alt']),
          'title' => check_plain($vars['site_name']),
          'attributes' => array(
            'class' => 'subsite-logo',
          ),
        )
      );
      $vars['subsite_logo_html'] = l($img, "<front>", array('html' => TRUE));
    }
    $vars['subsite_site_name_html'] = l($vars['site_name'], "<front>");
  }
  // End else if subsite.

}

/**
 * Apply a subsite after the page that is being viewed is validated as such.
 *
 * @param object $node
 *   The subsite node object.
 * @param array $vars
 *   The variables array from hook_preprocess_page.
 *
 * Function tasks:
 *   1. Change $title [if set]
 *   2. Change $logo [if set]
 *   3. Change the $front_page url [if set]
 *   4. Create new $logo_title & $alt template variables
 *   5. Create completely new $subsite_logo and $subsite_title
 *      variables with links
 *   6. Override the site_logo variable with subsite logo if present.
 */
function stanford_subsites_apply_subsite($node, &$vars) {

  // Change the site title.
  if (isset($node->{SUBSITE_NAME_FIELD}[$node->language][0]["safe_value"])
    && !empty($node->{SUBSITE_NAME_FIELD}[$node->language][0]["safe_value"])) {
    $vars['site_name'] = $node->{SUBSITE_NAME_FIELD}[$node->language][0]["safe_value"];
    $vars['subsite_site_name_text'] = $vars['site_name'];
  }



  // Create new $logo_title and $alt variables for use in the page.tpl.php
  $vars['alt'] = $vars['site_name'];
  $vars['logo_title'] = $vars['site_name'];

  // Change the site logo.
  if (isset($node->{SUBSITE_LOGO_FIELD}[$node->language][0]["uri"])
    && !empty($node->{SUBSITE_LOGO_FIELD}[$node->language][0]["uri"])) {
    $vars['logo'] = file_create_url($node->{SUBSITE_LOGO_FIELD}[$node->language][0]["uri"]);

    // Check for alt and title information on the image field.
    if (isset($node->{SUBSITE_LOGO_FIELD}[$node->language][0]['alt']) &&
      !empty($node->{SUBSITE_LOGO_FIELD}[$node->language][0]['alt'])) {
      $vars['alt'] = t($node->{SUBSITE_LOGO_FIELD}[$node->language][0]['alt']);
    }

    // Title.
    if (isset($node->{SUBSITE_LOGO_FIELD}[$node->language][0]['title']) &&
      !empty($node->{SUBSITE_LOGO_FIELD}[$node->language][0]['title'])) {
      $vars['logo_title'] = t($node->{SUBSITE_LOGO_FIELD}[$node->language][0]['title']);
    }
  }

  // Setup subsite logo and title vars
  // ///////////////////////////////////////////////////////////////////////////

  // Handle the linkage to the subsite logo and title.
  if (isset($node->{SUBSITE_FRONT_PAGE_FIELD}[$node->language][0]["value"])) {

    // Support default themes
    // Change the front page variable to link to the subsite.
    if ($node->{SUBSITE_FRONT_PAGE_FIELD}[$node->language][0]["value"] == "subsite") {
      $vars['front_page'] = url('node/' . $node->nid, array('absolute' => TRUE));
    }

    // Support customized themes
    // Render the HTML for the logo.
    if ($vars['logo']) {
      $img = theme("image", array(
        'path' => $vars['logo'],
        'role' => 'presentation',
        'alt' => check_plain($vars['alt']),
        'title' => check_plain($vars['site_name']),
        'attributes' => array('class' => 'subsite-logo')
        )
      );
    }

    // Set the link setting as a variable for page.tpl.php
    $vars['subsite_name_logo_setting'] = $node->{SUBSITE_FRONT_PAGE_FIELD}[$node->language][0]["value"];

    // What the active subsite setting is.
    switch ($node->{SUBSITE_FRONT_PAGE_FIELD}[$node->language][0]["value"]) {

      // Link the logo and the title to the subsite.
      case "subsite":
        if ($vars['logo']) {
          $vars['subsite_logo'] = l($img, "node/" . $node->nid, array('html' => TRUE));
        }
        $vars['subsite_site_name_html'] = l($vars['site_name'], "node/" . $node->nid);

        // Set the variable as well for use in the theme.
        break;

      // Link the title to the subsite and the logo to the main site.
      case "split":
        if ($vars['logo']) {
          $vars['subsite_logo_html'] = l($img, "<front>", array('html' => TRUE));
        }
        $vars['subsite_site_name_html'] = l($vars['site_name'], "node/" . $node->nid);
        break;

      // Link both to main site.
      default:
        if ($vars['logo']) {
          $vars['subsite_logo_html'] = l($img, "<front>", array('html' => TRUE));
        }
        $vars['subsite_site_name_html'] = l($vars['site_name'], "<front>");
    }

  }

  // SUBSITE SLOGAN
  // ///////////////////////////////////////////////////////////////////////////

  if (isset($node->{SUBSITE_SLOGAN_FIELD}[$node->language][0]["value"])) {
    $vars['site_slogan'] = t($node->{SUBSITE_SLOGAN_FIELD}[$node->language][0]["value"]);
  }

  // FRONT Variables
  // ///////////////////////////////////////////////////////////////////////////

  // Set the url for use in the theme to the active subsite.
  $vars['subsite_front'] = url(
    'node/' . $node->nid,
    array('absolute' => TRUE)
  );

}

/**
 * Implements hook_node_submit().
 *
 * @param object $node
 *   The node object being updated in response to a form submission.
 * @param array $form
 *   The form being used to edit the node.
 * @param array $form_state
 *   The form state array.
 *
 * Utiltity tasks for saving nodes of various types
 * 1. Clear path caches for subsites
 */
function stanford_subsites_node_submit($node, $form, &$form_state) {

  // If we are saveing a subsite content type clear path cache
  // and perform subsite specific handling.
  if ($node->type == SUBSITE_CONTENT_TYPE) {
    // Clear all path caches.
    cache_clear_all('stanford_subsites_subsite_paths', 'cache', TRUE);
  }

}

/**
 * Handles the insert of a new subsite content type.
 *
 * @param object $node
 *   The node object
 *
 * Tasks:
 * 1. Create subsite term
 * 2. Check for subsite ref in order to set active workspace
 */
function stanford_subsites_node_insert($node) {

  // We have a new subsite content type.
  if ($node->type == SUBSITE_CONTENT_TYPE) {

    // Storage for passing arguments to subsequential functions.
    $args = array();

    // If menu/menublock creation is enabled do it!
    if (variable_get("stanford_subsite_enabled_menus", FALSE)) {
      $args += _create_subsite_menu_and_menublock($node);
      _enable_menu_for_subsite_content_types($args['menu']);
    }

    // Create a subsite context for this subsite.
    _create_subsite_context($node, $args);

  }

}


/**
 * Implements hook_node_update().
 *
 * @param object $node
 *   The node object.
 *
 * 1. Clears the path cache for subsite nodes
 * 2. Checks for subsite ref field in order to set the active subsite workspace
 */
function stanford_subsites_node_update($node) {

  // Clear out all of the subsite paths so they get updated.
  if ($node->type == SUBSITE_CONTENT_TYPE) {
    // Clear all path caches.
    cache_clear_all('stanford_subsites_subsite_paths', 'cache', TRUE);
  }

}


/**
 * Implements pathauto_alias_alter().
 *
 * @param string $alias
 *   The subsite alias
 * @param object $context
 *   The context object.
 *
 * Prepends the pathalias of the subsite to a node being referenced to one
 */
function stanford_subsites_pathauto_alias_alter(&$alias, $context) {
  $node = (isset($context['data']['node'])) ? $context['data']['node'] : FALSE;
  $original_alias = $alias;

  // A taxonomy term or a user.
  if (!$node) {
    return;
  }

  // If there is a reference to a subsite then alter the pathauto_alias
  // if (isset($node->{SUBSITE_REF_FIELD}[$node->language][0]['target_id']) &&
  // is_numeric($node->{SUBSITE_REF_FIELD}[$node->language][0]['target_id'])) {
  //   $subsite_node = node_load($node->{SUBSITE_REF_FIELD}[$node->language][0]['target_id']);
  //   $alias = drupal_get_path_alias("node/" . $subsite_node->nid) . "/" . $original_alias;
  // }

}

/**
 * Implements hook_form_alter().
 *
 * Add the active theme options to the theme field
 */
function stanford_subsites_form_node_form_alter(&$form, &$form_state, $form_id) {

  // ONLY Subsite content types.
  // ---------------------------------------------------------------------------
  if ($form_id == SUBSITE_CONTENT_TYPE . "_node_form") {
    stanford_subsites_form_node_form_alter_subsite_node($form, $form_state, $form_id);
    return;
  }

}

/**
 * Alter the subsite node on form submit.
 *
 * @param array $form
 *   The form array
 * @param array $form_state
 *   The submitted form state
 * @param int $form_id
 *   The form idate(format)
 */
function stanford_subsites_form_node_form_alter_subsite_node(&$form, &$form_state, $form_id) {
  $node = $form['#node'];

  // Add only enabled themes to the theme drop down options...
  $themes = list_themes();
  foreach ($themes as $k => $theme) {
    if (!$theme->status) {
      continue;
    }
    $form[SUBSITE_THEME_FIELD][$node->language]['#options'][$k] = $k;
  }

  // Set the default value.
  $form[SUBSITE_THEME_FIELD][$node->language]['#default_value'] = (isset($node->{SUBSITE_THEME_FIELD}[$node->language][0]['value'])) ? $node->{SUBSITE_THEME_FIELD}[$node->language][0]['value'] : "default";

  // Add a link to enable more themes below the field.
  $form[SUBSITE_THEME_FIELD][$node->language]["#description"] = l(t('Enable more themes here'), "admin/appearance");

  // Add a validation hook.
  $form['#validate'][] = "stanford_subsites_form_node_form_alter_subsite_node_validate";
}

/**
 * Validate hook.
 * @param  [type] $form       [description]
 * @param  [type] $form_state [description]
 * @return [type]             [description]
 */
function stanford_subsites_form_node_form_alter_subsite_node_validate($form, $form_state) {
  $values = $form_state['values'];
  $lang = $form['language']["#value"];

  // If this is a new node ...
  if (empty($values['nid'])) {
    $term_name = $values[SUBSITE_TAGS_FIELD][$lang][0]['name'];
    $found = taxonomy_get_term_by_name($term_name, SUBSITE_VOCAB);
    if ($found) {
      form_set_error(SUBSITE_TAGS_FIELD, "Subsite term name not unqiue. Please choose another name.");
    }
  }

}

// Fields.
// ////////////////////////////////////////////////////////////////////////////

/**
 * Implements hook_field_access().
 */
function stanford_subsites_field_access($op, $field, $entity_type, $entity, $account) {

  // Check to see if user can edit the subsite selection field.
  if ($field['field_name'] == SUBSITE_TAGS_FIELD && $op == 'edit') {
    return user_access('administer subsite selection', $account);
  }

  return TRUE;
}

// Tokens.
// ////////////////////////////////////////////////////////////////////////////

/**
 * Implements hook_token_info().
 */
function stanford_subsites_token_info() {

  // Active subsite specific tokens.
  $types['stanford_subsites'] = array(
    'name' => t("Stanford Subsites"),
    'description' => t("The Stanford Subsite Project."),
  );

  // Active subsite page title $node->title
  $stanford_subsites['active_subsite_page_title'] = array(
    'name' => t("Active Subsite Page Title"),
    'description' => t("The Active Subsite Page Title"),
  );

  // Active subsite site name $node->field_stanford_subsite_site_name
  $stanford_subsites['active_subsite_site_name'] = array(
    'name' => t("The Active Subsite Site Name"),
    'description' => t("The site name of the active subsite."),
  );

  // The absolute url path to the active subsite.
  $stanford_subsites['active_subsite_url'] = array(
    'name' => t("The Active Subsite Url Path"),
    'description' => t("The url path to the active subsite."),
  );

  // The node id of the active subsite. $node->nid
  $stanford_subsites['active_subsite_node_id'] = array(
    'name' => t("The Active Subsite Node ID"),
    'description' => t("The node ID of the active subsite."),
  );

  return array(
    'types' => $types,
    'tokens' => array(
      'stanford_subsites' => $stanford_subsites,
    ),
  );
}


/**
 * Implements hook_tokens().
 */
function stanford_subsites_tokens_tokens($type, $tokens, array $data = array(), array $options = array()) {
  $subsite = stanford_subsites_get_active_subsite();

  // If there is no active subsite do not return anything.
  if (!$subsite) {
    return array();
  }

  $replacements = array();

  if ($type == 'stanford_subsites') {
    foreach ($tokens as $name => $original) {
      switch ($name) {
        case 'active_subsite_page_title':
          $replacements[$original] = t($subsite->title);
          break;

        case 'active_subsite_site_name':
          $replacements[$original] = t($subsite->{SUBSITE_NAME_FIELD}[$subsite->language][0]['safe_value']);
          break;

        case 'active_subsite_url':
          $replacements[$original] = url('node/' . $subsite->nid, array('absolute' => TRUE));
          break;

        case 'active_subsite_node_id':
          $replacements[$original] = $subsite->nid;
          break;
      }
    }
  }

  return $replacements;
}


// ////////////////////////////////////////////////////////////////////////////
// VIEWS PLUGINS and OTHER //
// ////////////////////////////////////////////////////////////////////////////

/**
 * Implments hook_views_api().
 */
function stanford_subsites_views_api() {
  return array("version" => "3.0");
}

// More in views.inc



// ////////////////////////////////////////////////////////////////////////////
// CONTEXT PLUGINS //
// ////////////////////////////////////////////////////////////////////////////

/**
 * Implements hook_context_plugins().
 *
 * To define your plugins, classes, and class hierarchy.
 *
 * @return array
 *   An array of plugin information
 */
function stanford_subsites_context_plugins() {
  $plugins = array();
  $plugins['context_condition_active_subsite'] = array(
    'handler' => array(
      'path' => drupal_get_path('module', 'stanford_subsites') . '/plugins',
      'file' => 'context_condition_active_subsite.inc',
      'class' => 'context_condition_active_subsite',
      'parent' => 'context_condition',
    ),
  );
  return $plugins;
}

/**
 * Implements hook_context_registry().
 *
 * To define your conditions and/or reactions and map them to plugins.
 *
 * @return array
 *   An array of configuration values.
 */
function stanford_subsites_context_registry() {
  return array(
    'conditions' => array(
      'active_subsite' => array(
        'title' => t('Active Subsite'),
        'plugin' => 'context_condition_active_subsite',
      ),
    ),
  );
}

/**
 * Execute Context active subsite conditions.
 *
 * Allows modules to hook into Context's hook_page_build to execute their
 * conditions at an appropriate time before the firing of reactions.
 */
function stanford_subsites_context_page_condition() {

  $plugin = context_get_plugin('condition', 'active_subsite');
  if ($plugin) {
    $plugin->execute();
  }

}


